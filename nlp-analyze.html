<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy"
    content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; connect-src 'self'; img-src 'self' data:; frame-ancestors 'none';">
  <title>RE:PROMPT | KINETIC NEURAL ENGINE</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700;900&family=Syne:wght@400;700;800&family=Outfit:wght@900&display=swap"
    rel="stylesheet">

  <style>
    :root {
      --bg: #000000;
      --fg: #F4F4F4;
      --accent: #FF3D00;
      --accent-green: #39FF14;
      --accent-yellow: #FFE600;
      --accent-blue: #0047FF;
      --accent-pink: #FF00E5;

      --border: 4px solid var(--fg);
      --border-thin: 2px solid var(--fg);
      --shadow: 10px 10px 0px rgba(255, 255, 255, 0.05);

      /* Kinetic Animation Transitions */
      --ease-out-expo: cubic-bezier(0.19, 1, 0.22, 1);
      --ease-in-out-back: cubic-bezier(0.68, -0.6, 0.32, 1.6);
      --transition-smooth: all 0.6s var(--ease-out-expo);
      --transition-snappy: all 0.3s var(--ease-out-expo);
    }

    /* â”€â”€ Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      cursor: none;
      /* Custom cursor implementation below */
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      background: var(--bg);
      color: var(--fg);
      font-family: 'Space Grotesk', sans-serif;
      overflow-x: hidden;
      line-height: 1.1;
      word-break: break-word;
    }

    /* Custom Cursor */
    #cursor {
      width: 20px;
      height: 20px;
      background: var(--accent-green);
      border-radius: 50%;
      position: fixed;
      pointer-events: none;
      z-index: 10000;
      mix-blend-mode: difference;
      transition: transform 0.1s var(--ease-out-expo);
    }

    #cursor-follower {
      width: 40px;
      height: 40px;
      border: 2px solid var(--fg);
      border-radius: 50%;
      position: fixed;
      pointer-events: none;
      z-index: 9999;
      transition: all 0.3s var(--ease-out-expo);
    }

    /* Texture layer */
    body::after {
      content: "";
      position: fixed;
      inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3 RIGHT%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='1.5' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
      opacity: 0.04;
      pointer-events: none;
      z-index: 9998;
      filter: invert(1);
    }

    /* â”€â”€ Kinetic Components â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .magnetic-wrap {
      display: inline-block;
      transition: transform 0.3s var(--ease-out-expo);
    }

    /* â”€â”€ Intro Manifesto â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #manifesto {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      padding: 80px 40px;
      max-width: 1200px;
      margin: 0 auto;
      position: relative;
    }

    .manifesto-badge {
      font-family: 'Syne', sans-serif;
      font-weight: 800;
      text-transform: uppercase;
      font-size: 14px;
      color: var(--accent-yellow);
      border: var(--border-thin);
      padding: 8px 16px;
      display: inline-block;
      margin-bottom: 40px;
      transform: rotate(-2deg);
      transition: var(--transition-snappy);
    }

    .manifesto-badge:hover {
      transform: rotate(0deg) scale(1.1);
      background: var(--fg);
      color: var(--bg);
    }

    .manifesto-title {
      font-family: 'Outfit', sans-serif;
      font-size: clamp(3rem, 10vw, 9rem);
      line-height: 0.8;
      text-transform: uppercase;
      margin-bottom: 60px;
      letter-spacing: -0.05em;
    }

    .manifesto-title span {
      display: inline-block;
      transition: transform 0.5s var(--ease-out-expo);
    }

    .manifesto-title:hover span {
      transform: skewX(-15deg) translateY(-10px);
      color: var(--accent-green);
    }

    .manifesto-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 40px;
      margin-top: 60px;
    }

    .manifesto-card {
      border-left: var(--border);
      padding: 30px;
      transition: var(--transition-smooth);
      background: transparent;
    }

    .manifesto-card:hover {
      background: rgba(255, 255, 255, 0.05);
      padding-left: 50px;
      border-left-width: 15px;
      border-left-color: var(--accent-pink);
    }

    .manifesto-card h3 {
      font-family: 'Syne', sans-serif;
      font-size: 32px;
      text-transform: uppercase;
      margin-bottom: 15px;
      color: var(--accent-green);
      transition: var(--transition-snappy);
    }

    .manifesto-card:hover h3 {
      color: var(--fg);
      transform: scale(1.05);
    }

    .manifesto-card p {
      font-size: 18px;
      font-weight: 500;
      opacity: 0.6;
      line-height: 1.4;
    }

    /* â”€â”€ Neural Engine Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .poster-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 100px 40px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 60px;
      min-height: 100vh;
      border-top: var(--border);
    }

    @media (max-width: 1024px) {
      .poster-container {
        grid-template-columns: 1fr;
        padding: 60px 20px;
      }
    }

    /* â”€â”€ Title Typography â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .hero-title {
      font-family: 'Syne', sans-serif;
      font-weight: 800;
      font-size: clamp(2.5rem, 8vw, 6rem);
      text-transform: uppercase;
      letter-spacing: -0.04em;
      line-height: 0.9;
      margin-bottom: 30px;
      perspective: 1000px;
    }

    .hero-title .highlight {
      color: var(--fg);
      display: block;
      transition: var(--transition-smooth);
    }

    .hero-title:hover span {
      transform: translateZ(50px) scale(1.05);
      color: var(--accent-green);
    }

    .hero-title:hover .highlight {
      color: var(--accent-yellow);
    }

    /* â”€â”€ Inputs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    textarea {
      width: 100%;
      background: rgba(255, 255, 255, 0.02);
      border: var(--border-thin);
      padding: 30px;
      font-family: 'Space Grotesk', sans-serif;
      font-size: 24px;
      font-weight: 700;
      color: var(--fg);
      resize: none;
      min-height: 400px;
      outline: none;
      transition: var(--transition-smooth);
    }

    textarea:focus {
      background: rgba(255, 255, 255, 0.05);
      border-color: var(--accent-yellow);
      box-shadow: 20px 20px 0px rgba(57, 255, 20, 0.1);
      transform: scale(1.02);
    }

    /* â”€â”€ Action Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .action-button {
      background: var(--fg);
      color: var(--bg);
      border: none;
      padding: 25px 50px;
      font-family: 'Outfit', sans-serif;
      font-size: 20px;
      font-weight: 900;
      text-transform: uppercase;
      box-shadow: 10px 10px 0px var(--accent-pink);
      display: inline-flex;
      align-items: center;
      gap: 15px;
      transition: var(--transition-smooth);
      margin-top: 30px;
      position: relative;
      overflow: hidden;
    }

    .action-button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: var(--accent-green);
      transition: var(--transition-smooth);
      z-index: -1;
    }

    .action-button:hover {
      color: var(--bg);
      box-shadow: 15px 15px 0px var(--fg);
      transform: translate(-5px, -5px);
    }

    .action-button:hover::before {
      left: 0;
    }

    .action-button:disabled {
      opacity: 0.2;
      cursor: not-allowed;
      transform: none !important;
      box-shadow: none !important;
    }

    /* â”€â”€ Steps â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .step-view {
      display: none;
      opacity: 0;
      transform: translateY(40px);
      transition: var(--transition-smooth);
    }

    .step-view.active {
      display: grid;
      opacity: 1;
      transform: translateY(0);
    }

    /* â”€â”€ Question Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .question-zine {
      border: var(--border-thin);
      padding: 30px;
      background: #080808;
      margin-bottom: 30px;
      transition: var(--transition-smooth);
      position: relative;
    }

    .question-zine:hover {
      transform: rotate(1deg) scale(1.03) translate(5px, -5px);
      border-color: var(--accent-blue);
      box-shadow: -10px 10px 0px var(--accent-pink);
    }

    /* â”€â”€ Results â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .master-prompt {
      font-size: 1.25rem;
      font-weight: 700;
      border: var(--border);
      padding: 40px;
      background: #000;
      color: var(--accent-yellow);
      box-shadow: 20px 20px 0px rgba(0, 71, 255, 0.2);
      white-space: pre-wrap;
      margin-bottom: 80px;
      transition: var(--transition-smooth);
    }

    .master-prompt:hover {
      transform: scale(1.02);
      box-shadow: 25px 25px 0px var(--accent-green);
    }

    .platform-poster {
      border-top: var(--border-thin);
      padding: 40px 0;
      transition: var(--transition-smooth);
    }

    .platform-poster:hover {
      border-top-color: var(--accent-pink);
      background: rgba(255, 255, 255, 0.02);
      padding-left: 20px;
    }

    .platform-title {
      font-family: 'Outfit', sans-serif;
      font-size: 50px;
      text-transform: uppercase;
      color: var(--accent-green);
      margin-bottom: 15px;
      transition: var(--transition-snappy);
    }

    .platform-poster:hover .platform-title {
      color: var(--accent-pink);
      letter-spacing: 0.1em;
    }

    .platform-copy {
      background: var(--fg);
      color: var(--bg);
      padding: 10px 20px;
      font-weight: 900;
      text-transform: uppercase;
      border: none;
      margin-top: 20px;
      transition: var(--transition-snappy);
    }

    .platform-copy:hover {
      background: var(--accent-yellow);
      transform: translateY(-5px) skewX(-10deg);
      box-shadow: 5px 5px 0px var(--fg);
    }

    /* â”€â”€ Loader â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #loader {
      position: fixed;
      inset: 0;
      background: var(--bg);
      color: var(--fg);
      z-index: 10000;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
    }

    .loader-text {
      font-family: 'Outfit', sans-serif;
      font-size: 8vw;
      text-transform: uppercase;
      animation: jitter 0.1s infinite;
    }

    @keyframes jitter {
      0% {
        transform: translate(2px, 2px);
      }

      50% {
        transform: translate(-2px, -2px);
      }

      100% {
        transform: translate(0, 0);
      }
    }

    /* â”€â”€ Reveal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .reveal {
      opacity: 0;
      transform: translateY(30px);
      transition: all 1s var(--ease-out-expo);
    }

    .reveal.visible {
      opacity: 1;
      transform: translateY(0);
    }

    /* â”€â”€ Accessibility Toolbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .a11y-toolbar {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10001;
      display: flex;
      gap: 10px;
    }

    .a11y-btn {
      background: var(--bg);
      color: var(--fg);
      border: 2px solid var(--fg);
      padding: 8px 12px;
      font-family: 'Syne', sans-serif;
      font-weight: 700;
      font-size: 12px;
      cursor: pointer;
      transition: var(--transition-snappy);
    }

    .a11y-btn:hover {
      background: var(--fg);
      color: var(--bg);
    }

    /* â”€â”€ High Contrast Mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    body.hc {
      --bg: #ffffff;
      --fg: #000000;
      --accent: #d32f2f;
      --accent-green: #1b5e20;
      --accent-yellow: #fbc02d;
      --accent-blue: #0d47a1;
      --accent-pink: #c2185b;
      --border: 4px solid #000;
      --border-thin: 2px solid #000;
    }

    body.hc #cursor,
    body.hc #cursor-follower {
      mix-blend-mode: multiply;
      border-color: #000;
    }

    body.hc .master-prompt {
      background: #f0f0f0;
      border: 4px solid #000;
    }

    body.hc .manifesto-card:hover {
      background: rgba(0, 0, 0, 0.1);
    }

    /* â”€â”€ Tooltips â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    [data-tooltip] {
      position: relative;
    }

    [data-tooltip]::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%) translateY(0);
      background: var(--fg);
      color: var(--bg);
      padding: 6px 12px;
      font-size: 10px;
      font-family: monospace;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: var(--transition-snappy);
      z-index: 1000;
      margin-bottom: 10px;
      border: 1px solid var(--bg);
    }

    [data-tooltip]:hover::after {
      opacity: 1;
      transform: translateX(-50%) translateY(-5px);
    }

    /* â”€â”€ Mobile Toolbar Overflow â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (max-width: 639px) {
      .qa-toolbar-container {
        flex-direction: column;
        align-items: stretch !important;
      }

      .qa-btns-wrapper {
        display: none;
        flex-direction: column;
        gap: 10px;
        margin-top: 15px;
      }

      .qa-btns-wrapper.open {
        display: flex;
      }

      .qa-overflow-toggle {
        display: block !important;
      }
    }

    .qa-overflow-toggle {
      display: none;
      width: 100%;
      padding: 12px;
      background: transparent;
      border: 2px solid var(--fg);
      color: var(--fg);
      font-family: inherit;
      font-weight: 700;
      cursor: pointer;
    }
  </style>
</head>

<body>

  <!-- CUSTOM CURSOR -->
  <div id="cursor"></div>
  <div id="cursor-follower"></div>

  <!-- A11Y TOOLBAR -->
  <div class="a11y-toolbar">
    <button class="a11y-btn" onclick="toggleHC()" title="Toggle High Contrast">â¬œ HC</button>
    <button class="a11y-btn" onclick="changeFontSize(-2)" title="Decrease Font Size">Aâˆ’</button>
    <button class="a11y-btn" onclick="changeFontSize(2)" title="Increase Font Size">A+</button>
  </div>

  <style>
    /* Typography Overrides to prevent word splits and center layout */
    body {
      word-break: normal !important;
      overflow-wrap: anywhere !important;
    }

    .hero-title,
    .manifesto-title {
      word-break: normal !important;
      overflow-wrap: normal !important;
      text-align: center;
    }

    .hero-title span,
    .manifesto-title span {
      display: inline-block;
      white-space: nowrap;
      transition: var(--transition-smooth);
    }

    .manifesto-title:hover span {
      transform: skewX(-5deg) translateY(-5px) scale(1.02);
    }

    .manifesto-title {
      font-size: clamp(2rem, 12vw, 8rem) !important;
      position: relative;
      width: 100%;
      max-width: 100vw;
      margin: 0 auto;
    }

    /* Merged Percentage Style */
    .merged-pct {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-right: 0.1em;
    }

    .merged-pct .pct {
      font-size: 0.4em;
      position: absolute;
      top: 0;
      right: -0.3em;
      opacity: 0.6;
      color: var(--fg);
      transform: rotate(-15deg);
      pointer-events: none;
    }

    .manifesto-grid {
      justify-content: center;
      text-align: center;
    }

    #manifesto .reveal {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
  </style>

  <!-- MANIFESTO SECTION -->
  <section id="manifesto" style="text-align: center; overflow: hidden;">
    <div class="reveal">
      <div class="manifesto-badge">KINETIC NEURAL ENGINE</div>
      <h1 class="manifesto-title" style="margin: 0 auto 40px auto; padding: 0 10px;">
        <span
          style="color: var(--accent-green); display: inline-flex; align-items: center; justify-content: center; transform-origin: center;">
          <div class="merged-pct" style="font-size: 1.1em; transform: scale(1.1); margin-right: 0.2em;">
            100<span class="pct"
              style="font-size: 0.35em; color: var(--accent-green); opacity: 1; top: 0.2em; right: -0.4em;">%</span>
          </div>
          <span style="letter-spacing: -0.05em;">VISION</span>
        </span>
        <br>
        <span
          style="color: var(--accent-pink); display: inline-flex; align-items: center; justify-content: center; transform-origin: center;">
          <div class="merged-pct" style="font-size: 1.1em; transform: scale(1.1); margin-right: 0.2em;">
            0<span class="pct"
              style="font-size: 0.35em; color: var(--accent-pink); opacity: 1; top: 0.2em; right: -0.4em;">%</span>
          </div>
          <span style="letter-spacing: -0.05em;">CONTEXT LOSS</span>
        </span>
      </h1>
    </div>

    <div class="manifesto-grid">
      <div class="manifesto-card reveal" style="transition-delay: 0.1s">
        <h3>WHAT?</h3>
        <p>A precision reasoning system transforming concept data into airtight AI architecture with zero detail loss.
        </p>
      </div>
      <div class="manifesto-card reveal" style="transition-delay: 0.2s">
        <h3>HOW?</h3>
        <p>Through active magnetic feedback loops, we extract every technical parameter and business requirement with
          precision.</p>
      </div>
      <div class="manifesto-card reveal" style="transition-delay: 0.3s">
        <h3>WHY?</h3>
        <p>Because static prompts lose context. Our interactive engine ensures your technical blueprint is hard-coded
          into the output.</p>
      </div>
    </div>

    <div class="reveal" style="transition-delay: 0.5s">
      <a href="#view-1" class="magnetic-wrap scroll-to-engine"
        style="margin-top: 100px; display: inline-flex; align-items: center; gap: 20px; font-weight: 800; font-family: Syne; color: white; text-decoration: none; font-size: 1.5rem;">
        INITIALIZE KINETIC ENGINE âžœ
      </a>
    </div>
  </section>

  <!-- NEURAL ENGINE -->
  <main id="engine">
    <!-- STEP 1: VISION -->
    <div id="view-1" class="step-view poster-container active">
      <div class="zine-left">
        <h1 class="hero-title"
          style="text-align: center; width: 100%; margin: 0 auto 40px auto; font-size: clamp(2rem, 10vw, 5.5rem);">
          <span class="highlight"
            style="display: block; white-space: nowrap; transform-origin: center; color: var(--accent-yellow);">INITIALIZE</span>
          <span style="display: block; white-space: nowrap; transform-origin: center; opacity: 0.8;">NEURAL</span>
          <span
            style="display: block; white-space: nowrap; transform-origin: center; color: var(--accent-green);">VISION</span>
        </h1>
        <p style="font-weight: 700; opacity: 0.5; max-width: 350px;">
          Inject your concept vision. Minimum 30 characters required to stabilize the reasoning vector.
        </p>
        <div class="reveal">
          <button class="action-button magnetic-wrap" id="btn-next-1" disabled>
            ACTIVATE ENGINE âžœ
          </button>
        </div>
      </div>
      <div class="zine-right">
        <div class="input-zine">
          <textarea id="vision-input" placeholder="Enter vision data..."></textarea>
        </div>
      </div>
    </div>

    <!-- STEP 2: REFINEMENT -->
    <div id="view-2" class="step-view poster-container">
      <div class="zine-left">
        <h1 class="hero-title">
          <span class="highlight">SYNCING</span>
          CONTEXT DATA
        </h1>
        <p style="font-weight: 700; opacity: 0.5; max-width: 350px;">
          Input additional parameters to reach 100% fidelity. Detailed data ensures zero loss in synthesis.
        </p>
      </div>
      <div class="zine-right">
        <div id="questions-container">
          <!-- Dynamic Content -->
        </div>
        <button class="action-button magnetic-wrap" id="btn-generate"
          style="background: var(--accent-yellow); color: #000; box-shadow: 10px 10px 0px var(--accent-green);">
          SYNTHESIZE ALL âžœ
        </button>
      </div>
    </div>

    <!-- STEP 3: OUTPUT -->
    <div id="view-3" class="step-view poster-container" style="grid-template-columns: 1fr;">
      <div class="zine-header">
        <h1 class="hero-title" style="margin-bottom: 20px;">
          <span class="highlight">SYNTHESIS</span>
          COMPLETE
        </h1>
        <button class="action-button magnetic-wrap" onclick="copyText('master')"
          style="background: var(--accent-yellow); color: #000; font-size: 14px; padding: 12px 24px; box-shadow: 5px 5px 0px var(--fg); margin-bottom: 40px; margin-top: 0;">
          COPY MASTER PROMPT âžœ
        </button>
      </div>

      <div class="master-prompt" id="master-prompt-display"></div>

      <div class="platform-grid" id="platform-grid">
        <!-- Dynamic Content -->
      </div>

      <div style="margin-top:100px; display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;">
        <button class="action-button magnetic-wrap" onclick="exportMarkdown()"
          style="background: var(--fg); color: var(--bg); font-size: 14px; padding: 15px 30px; box-shadow: 5px 5px 0px var(--accent-blue);">
          EXPORT MD âžœ
        </button>
        <button class="action-button magnetic-wrap" onclick="window.print()"
          style="background: var(--fg); color: var(--bg); font-size: 14px; padding: 15px 30px; box-shadow: 5px 5px 0px var(--accent-pink);">
          EXPORT PDF âžœ
        </button>
        <button class="action-button magnetic-wrap" onclick="location.reload()"
          style="background: var(--accent-pink); color: #fff; font-size: 14px; padding: 15px 30px;">
          RESET ENGINE âžœ
        </button>
      </div>

      <style>
        @media print {

          .a11y-toolbar,
          .action-button,
          .zine-header,
          #manifesto,
          .qa-toolbar-container,
          .a11y-btn,
          #run-sim-btn {
            display: none !important;
          }

          body {
            background: white !important;
            color: black !important;
          }

          .poster-container {
            padding: 0 !important;
            border: none !important;
          }

          #platform-grid {
            display: block !important;
          }

          .platform-poster {
            break-inside: avoid;
            border-top: 1px solid #ccc !important;
          }
        }
      </style>
    </div>
  </main>

  <!-- LOADER -->
  <div id="loader">
    <div class="loader-text" id="loader-main">SYNTHESIZING</div>
    <div style="font-weight: 800; color: var(--accent-green); margin-top: 20px;" id="loader-sub">ALIGNING VECTORS</div>
  </div>

  <script>
    const API = '/analyze.php';
    // â”€â”€ XSS Guard: escape all dynamic content before injecting into innerHTML â”€â”€
    function escHtml(str) {
      return String(str === null || str === undefined ? '' : str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    // â”€â”€ Non-blocking error banner (replaces alert()) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showError(msg) {
      let banner = document.getElementById('error-banner');
      if (!banner) {
        banner = document.createElement('div');
        banner.id = 'error-banner';
        banner.style.cssText = 'position:fixed;top:0;left:0;right:0;z-index:99999;background:#c0392b;color:#fff;padding:16px 24px;font-weight:700;font-family:monospace;font-size:14px;display:flex;justify-content:space-between;align-items:center;';
        document.body.prepend(banner);
      }
      banner.innerHTML = '';
      const t = document.createTextNode('âš  ' + msg);
      const x = document.createElement('button');
      x.textContent = 'Ã—';
      x.style.cssText = 'background:none;border:none;color:#fff;cursor:pointer;font-size:18px;padding:0 0 0 16px;';
      x.onclick = () => banner.remove();
      banner.appendChild(t);
      banner.appendChild(x);
    }

    let state = { vision: '', questions: [], answers: {}, results: null };

    // --- CUSTOM KINETIC CURSOR ---
    const cursor = document.getElementById('cursor');
    const follower = document.getElementById('cursor-follower');

    document.addEventListener('mousemove', (e) => {
      cursor.style.transform = `translate(${e.clientX - 10}px, ${e.clientY - 10}px)`;
      follower.style.transform = `translate(${e.clientX - 20}px, ${e.clientY - 20}px)`;
    });

    document.querySelectorAll('button, a, textarea').forEach(el => {
      el.addEventListener('mouseenter', () => {
        follower.style.transform = `translate(${cursor.offsetLeft - 10}px, ${cursor.offsetTop - 10}px) scale(2)`;
        follower.style.background = 'rgba(255,255,255,0.1)';
      });
      el.addEventListener('mouseleave', () => {
        follower.style.transform = `translate(${cursor.offsetLeft}px, ${cursor.offsetTop}px) scale(1)`;
        follower.style.background = 'transparent';
      });
    });

    // --- MAGNETIC HOVER SYSTEM ---
    const magneticElements = document.querySelectorAll('.magnetic-wrap');
    magneticElements.forEach(el => {
      el.addEventListener('mousemove', (e) => {
        const rect = el.getBoundingClientRect();
        const x = e.clientX - rect.left - rect.width / 2;
        const y = e.clientY - rect.top - rect.height / 2;
        el.style.transform = `translate(${x * 0.3}px, ${y * 0.3}px)`;
      });
      el.addEventListener('mouseleave', () => {
        el.style.transform = `translate(0px, 0px)`;
      });
    });

    // --- ENGINE LOGIC ---
    const visionInput = document.getElementById('vision-input');
    const btnNext1 = document.getElementById('btn-next-1');
    const loader = document.getElementById('loader');
    const loaderSub = document.getElementById('loader-sub');

    visionInput.addEventListener('input', () => {
      btnNext1.disabled = visionInput.value.length < 30;
    });

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(e => {
        if (e.isIntersecting) e.target.classList.add('visible');
      });
    }, { threshold: 0.1 });

    document.querySelectorAll('.reveal').forEach(el => observer.observe(el));

    function transitionTo(step) {
      const current = document.querySelector('.step-view.active');
      current.style.opacity = '0';
      current.style.transform = 'translateY(-40px)';

      setTimeout(() => {
        current.classList.remove('active');
        const next = document.getElementById(`view-${step}`);
        next.classList.add('active');
        next.scrollIntoView({ behavior: 'smooth' });
      }, 600);
    }

    btnNext1.addEventListener('click', async () => {
      state.vision = visionInput.value.trim();
      showLoader('MAPPING NEURAL VECTORS');

      try {
        const res = await fetch(API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ mode: 'clarify', text: state.vision })
        });
        const data = await res.json();
        if (data.error) throw new Error(data.error);

        state.questions = data.clarification_questions || data.questions || [];
        renderQuestions();
        transitionTo(2);
      } catch (err) {
        showError('Analysis failed: ' + err.message);
      } finally {
        hideLoader();
      }
    });

    document.getElementById('btn-generate').addEventListener('click', async () => {
      const inputs = document.querySelectorAll('.answer-area');
      inputs.forEach(el => state.answers[el.dataset.q] = el.value);

      showLoader('FIDELITY_SYNTHESIS');

      try {
        const res = await fetch(API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ mode: 'generate', text: state.vision, answers: state.answers })
        });
        const data = await res.json();
        if (data.error) throw new Error(data.error);

        state.results = data;
        renderResults();
        transitionTo(3);
      } catch (err) {
        showError('Synthesis failed: ' + err.message);
      } finally {
        hideLoader();
      }
    });

    function copyText(id) {
      let content = '';
      if (id === 'master') {
        content = document.getElementById('master-prompt-display').textContent;
      } else {
        const poster = document.getElementById(`poster-${id}`);
        content = poster.querySelector('pre').textContent;
      }
      navigator.clipboard.writeText(content);
      const btn = event.target;
      const original = btn.textContent;
      btn.textContent = 'COPIED! âœ“';
      btn.style.background = 'var(--accent-green)';
      setTimeout(() => {
        btn.textContent = original;
        btn.style.background = id === 'master' ? 'var(--accent-yellow)' : 'var(--fg)';
      }, 2000);
    }

    function renderQuestions() {
      const container = document.getElementById('questions-container');
      container.innerHTML = state.questions.map((q, i) => `
                <div class="question-zine reveal" style="transition-delay: ${i * 0.1}s">
                    <div style="font-weight: 900; color: var(--accent-pink); margin-bottom: 10px; font-size: 11px;">SYNC_PARAM_${i + 1}</div>
                    <p style="font-weight: 700; font-size: 1.5rem; margin-bottom: 20px;">${typeof q === 'object' ? escHtml(q.question || q.text || JSON.stringify(q)) : escHtml(String(q))}</p>
                    <textarea class="answer-area" data-q="${typeof q === 'object' ? escHtml(q.question || q.text || JSON.stringify(q)) : escHtml(String(q))}" placeholder="Locked context..." style="min-height: 100px; font-size: 18px; border: none; background: #111; padding: 20px;"></textarea>
                </div>
            `).join('');

      setTimeout(() => {
        document.querySelectorAll('#questions-container .reveal').forEach(el => observer.observe(el));
      }, 100);
    }

    function renderResults() {
      const display = document.getElementById('master-prompt-display');
      const grid = document.getElementById('platform-grid');
      const r = state.results;
      const prompts = r.generated_prompts || {};
      const cb = r.confidence_breakdown || {};
      const vl = r.validation_logic || {};

      const safeVal = (v, fallback = 'N/A') => {
        // All output HTML-escaped to prevent XSS from server/LLM data
        if (v === null || v === undefined) return escHtml(fallback);
        if (typeof v === 'string') return escHtml(v);
        if (typeof v === 'object') return escHtml(v.text || v.description || v.problem_description || JSON.stringify(v));
        return escHtml(String(v));
      };

      const likelihoodColor = (l) => ({ HIGH: 'var(--accent-pink)', MEDIUM: 'var(--accent-yellow)', LOW: 'var(--accent-green)' }[l] || 'var(--fg)');
      const priorityColor = (p) => ({ HIGH: 'var(--accent-pink)', MEDIUM: 'var(--accent-yellow)', LOW: 'var(--accent-green)' }[p] || 'var(--fg)');

      // Â§1 â€” Primary Output: Universal Master Prompt
      display.textContent = prompts.universal_master || 'Generating master prompt...';

      // Â§2-9 â€” Full v3 Structured Output
      grid.innerHTML = `
        <!-- â”€â”€ Â§1: Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div style="grid-column:1/-1; margin-bottom:60px; border-bottom:var(--border-thin); padding-bottom:30px;">
          <div style="font-size:11px; color:var(--accent-green); letter-spacing:4px; margin-bottom:12px;">RE-PROMPT v3.1 Â· HYBRID SEMANTIC ENFORCEMENT ENGINE</div>
          <h2 style="font-family:Outfit; font-size:3rem; text-transform:uppercase; color:var(--accent-yellow); margin:0;">Engineering Specification</h2>
          <p style="opacity:0.5; margin-top:8px; font-family:Syne;">TF-IDF fast-pass Â· LLM judge for gray zone Â· Consistency-coupled confidence Â· Server-enforced 422</p>
        </div>

        <!-- â”€â”€ Â§2: Refined Domain Specification â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div style="grid-column:1/-1; border-left:5px solid var(--accent-green); padding:30px 30px; background:#060606; margin-bottom:40px;">
          <div style="font-size:11px; color:var(--accent-green); letter-spacing:3px; margin-bottom:10px;">Â§1 Â· REFINED DOMAIN SPECIFICATION</div>
          <p style="font-size:1.3rem; line-height:1.7; font-weight:500;">${safeVal(r.refined_domain_specification || r.refined_problem_statement)}</p>
        </div>

        <!-- â”€â”€ Â§3: Assumptions Made â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div style="grid-column:1/-1; padding:30px; background:#070707; border:1px solid #222; margin-bottom:40px;">
          <div style="font-size:11px; color:var(--accent-yellow); letter-spacing:3px; margin-bottom:20px;">Â§2 Â· ASSUMPTIONS MADE â€” Every inferred detail declared explicitly</div>
          ${(r.assumptions_made || []).length === 0
          ? `<p style="opacity:0.4; font-style:italic;">No assumptions required â€” all details explicitly provided.</p>`
          : (r.assumptions_made || []).map(a => `
            <div style="display:flex; justify-content:space-between; align-items:flex-start; padding:15px 0; border-bottom:1px solid #111;">
              <div style="flex:1;">
                <strong style="color:var(--accent-yellow);">${safeVal(a.assumption)}</strong>
                <p style="opacity:0.5; font-size:0.9rem; margin-top:4px;">Reason: ${safeVal(a.reason)}</p>
              </div>
              <div style="flex-shrink:0; margin-left:20px; padding:4px 12px; border:1px solid var(--accent-pink); color:var(--accent-pink); font-size:11px; font-weight:700; border-radius:2px;">
                ${typeof a.confidence_impact === 'number' ? a.confidence_impact : -2} pts
              </div>
            </div>`).join('')}
        </div>

        <!-- â”€â”€ Â§4: Functional Components â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div style="grid-column:1/-1; padding:30px; border:1px solid #1a1a1a; margin-bottom:40px;">
          <div style="font-size:11px; color:var(--accent-blue); letter-spacing:3px; margin-bottom:20px;">Â§3 Â· CORE FUNCTIONAL COMPONENTS â€” Semantic Traceability</div>
          <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(340px,1fr)); gap:20px;">
            ${(r.core_functional_components || r.core_features || []).map(f => {
            const ts = f.trace_status || (f.is_speculative ? 'speculative' : 'traceable');
            const badgeColor = { traceable: 'var(--accent-green)', assumption: 'var(--accent-yellow)', speculative: 'var(--accent-pink)' }[ts] || 'var(--fg)';
            const borderColor = { traceable: 'var(--accent-green)', assumption: 'var(--accent-yellow)', speculative: 'var(--accent-pink)' }[ts] || 'var(--accent-blue)';
            const scoreNum = typeof f.trace_score === 'number' ? (f.trace_score * 100).toFixed(0) : null;
            const simSrc = f.similarity_source || 'tfidf';
            return `
              <div style="padding:20px; background:#060606; border-left:3px solid ${borderColor};">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                  <strong style="font-size:1rem;">${safeVal(f.name)}</strong>
                  <div style="display:flex; align-items:center; gap:6px;">
                    ${scoreNum !== null ? `<span style="font-size:10px; font-family:monospace; color:${badgeColor}; opacity:0.8;">${scoreNum}%</span>` : ''}
                    <span style="font-size:9px; padding:2px 8px; border:1px solid ${badgeColor}; color:${badgeColor}; text-transform:uppercase; font-weight:700;">${ts}</span>
                    ${simSrc === 'llm-judge' ? `<span style="font-size:9px; color:#888; border:1px solid #333; padding:1px 5px;" title="Verified via LLM judge">ðŸ¤–</span>` : ''}
                  </div>
                </div>
                <p style="opacity:0.7; font-size:0.9rem; margin-bottom:8px;">${safeVal(f.description)}</p>
                ${f.explainability_snippet ? `<div style="font-size:10px; color:${badgeColor}; opacity:0.6; margin-bottom:5px;">â†³ matched: "${safeVal(f.explainability_snippet)}"</div>` : ''}
                ${(f.trace_to_input || []).length > 0 ? `<div style="font-size:10px; color:#555;">traces: ${(f.trace_to_input || []).join(' Â· ')}</div>` : ''}
              </div>`;
          }).join('')}
          </div>
        </div>

        <!-- â”€â”€ Â§5: Non-Functional Requirements â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div style="padding:30px; background:#060606; border:1px solid #1a1a1a; margin-bottom:40px;">
          <div style="font-size:11px; color:var(--accent-pink); letter-spacing:3px; margin-bottom:20px;">Â§4 Â· NON-FUNCTIONAL REQUIREMENTS</div>
          ${(r.non_functional_requirements || []).map(n => `
            <div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #111;">
              <div>
                <span style="font-size:10px; color:var(--accent-blue); margin-right:10px;">${safeVal(n.category)}</span>
                <span style="opacity:0.8;">${safeVal(n.requirement)}</span>
              </div>
              <span style="font-size:11px; font-weight:700; color:${priorityColor(n.priority)}; flex-shrink:0; margin-left:15px;">${n.priority || 'MEDIUM'}</span>
            </div>`).join('') || '<p style="opacity:0.4;">No NFRs specified.</p>'}
        </div>

        <!-- â”€â”€ Â§6: Technical Architecture â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div style="padding:30px; border:1px solid #1a1a1a; margin-bottom:40px;">
          <div style="font-size:11px; color:var(--accent-blue); letter-spacing:3px; margin-bottom:20px;">Â§5 Â· TECHNICAL ARCHITECTURE</div>
          <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:15px; margin-bottom:20px;">
            ${['frontend', 'backend', 'ai_components', 'data_storage', 'deployment'].map(k => `
              <div style="padding:15px; background:#070707; border-top:2px solid var(--accent-blue);">
                <div style="font-size:10px; color:var(--accent-blue); margin-bottom:6px;">${k.toUpperCase().replace('_', ' ')}</div>
                <div style="font-weight:700;">${safeVal((r.technical_architecture || {})[k])}</div>
              </div>`).join('')}
          </div>
          ${r.technical_architecture?.justification ? `<div style="font-size:0.85rem; opacity:0.5; border-top:1px solid #111; padding-top:15px;">Justification: ${safeVal(r.technical_architecture.justification)}</div>` : ''}
        </div>

        <!-- â”€â”€ Â§7: Risk Analysis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div style="padding:30px; background:#060606; border:1px solid #1a1a1a; margin-bottom:40px;">
          <div style="font-size:11px; color:var(--accent-pink); letter-spacing:3px; margin-bottom:20px;">Â§6 Â· RISK ANALYSIS</div>
          ${(r.risk_analysis || []).map(risk => {
            const rd = typeof risk === 'string' ? { risk, likelihood: 'MEDIUM', mitigation: '' } : risk;
            return `
            <div style="padding:15px 0; border-bottom:1px solid #111;">
              <div style="display:flex; align-items:center; gap:12px; margin-bottom:6px;">
                <span style="font-size:10px; font-weight:700; padding:2px 8px; border:1px solid ${likelihoodColor(rd.likelihood)}; color:${likelihoodColor(rd.likelihood)};">${rd.likelihood || 'MEDIUM'}</span>
                <strong>${safeVal(rd.risk)}</strong>
              </div>
              <p style="opacity:0.5; font-size:0.85rem; padding-left:4px;">â†³ ${safeVal(rd.mitigation, 'No mitigation specified')}</p>
            </div>`;
          }).join('') || '<p style="opacity:0.4;">No risks identified.</p>'}
        </div>

        <!-- â”€â”€ Â§8: Validation Logic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div style="grid-column:1/-1; padding:30px; border:1px solid #2a1a00; background:#050501; margin-bottom:40px;">
          <div style="font-size:11px; color:var(--accent-yellow); letter-spacing:3px; margin-bottom:20px;">Â§7 Â· VALIDATION LOGIC â€” Hybrid Semantic Enforcement v3.1</div>
          <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:15px; margin-bottom:20px;">
            <div style="padding:15px; border:1px solid #222;">
              <div style="font-size:10px; opacity:0.5; margin-bottom:6px;">CONSISTENCY CHECK</div>
              <div style="font-size:1.2rem; font-weight:700; color:${vl.internal_consistency_check === 'PASS' ? 'var(--accent-green)' : 'var(--accent-yellow)'};">${vl.internal_consistency_check || 'N/A'}</div>
            </div>
            <div style="padding:15px; border:1px solid #222;">
              <div style="font-size:10px; opacity:0.5; margin-bottom:6px;">DOMAIN CONSISTENCY</div>
              <div style="font-size:1.2rem; font-weight:700; color:${(vl.domain_consistency_computed || 0) >= 80 ? 'var(--accent-green)' : (vl.domain_consistency_computed || 0) >= 60 ? 'var(--accent-yellow)' : 'var(--accent-pink)'};">${typeof vl.domain_consistency_computed === 'number' ? vl.domain_consistency_computed.toFixed(1) + '%' : 'N/A'}</div>
            </div>
            <div style="padding:15px; border:1px solid #222;">
              <div style="font-size:10px; opacity:0.5; margin-bottom:6px;">DRIFT INSTANCES</div>
              <div style="font-size:1.2rem; font-weight:700; color:${(vl.domain_drift_instances || []).length > 0 ? 'var(--accent-pink)' : 'var(--accent-green)'};">${(vl.domain_drift_instances || []).length}</div>
            </div>
            <div style="padding:15px; border:1px solid #222;">
              <div style="font-size:10px; opacity:0.5; margin-bottom:6px;">LLM JUDGE CALLS</div>
              <div style="font-size:1.2rem; font-weight:700; color:var(--accent-blue);">${typeof vl.llm_judge_calls === 'number' ? vl.llm_judge_calls : 'â€”'}</div>
            </div>
            <div style="padding:15px; border:1px solid #222;">
              <div style="font-size:10px; opacity:0.5; margin-bottom:6px;">AUTO PASS / FAIL</div>
              <div style="font-size:1.1rem; font-weight:700;"><span style="color:var(--accent-green);">${vl.tfidf_auto_pass_count ?? 'â€”'}</span>&nbsp;/&nbsp;<span style="color:var(--accent-pink);">${vl.tfidf_auto_fail_count ?? 'â€”'}</span></div>
            </div>
            <div style="padding:15px; border:1px solid #222;">
              <div style="font-size:10px; opacity:0.5; margin-bottom:6px;">ENGINE</div>
              <div style="font-size:0.65rem; font-weight:700; color:var(--accent-blue); font-family:monospace;">${vl.similarity_engine || 'legacy'}</div>
            </div>
          </div>
          ${(vl.domain_drift_instances || []).length > 0 ? `<div style="margin-top:15px;"><div style="font-size:11px; color:var(--accent-pink); margin-bottom:8px;">SPECULATIVE FEATURES</div>${(vl.domain_drift_instances || []).map(d => '<div style="padding:5px 0; font-size:0.85rem; opacity:0.7; border-bottom:1px solid #111;">âš  ' + d + '</div>').join('')}</div>` : '<div style="color:var(--accent-green); font-size:0.85rem; margin-top:10px;">âœ“ All features semantically traceable to user input</div>'}
          <p style="opacity:0.4; font-size:0.85rem; margin-top:15px;">${safeVal(vl.notes, '')}</p>
        </div>

        <!-- â”€â”€ Â§9: Confidence Score Breakdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div style="grid-column:1/-1; padding:40px; border:var(--border); background:#030303; margin-bottom:40px;">
          <div style="font-size:11px; color:var(--accent-green); letter-spacing:3px; margin-bottom:30px;">Â§8 Â· CONFIDENCE SCORE BREAKDOWN â€” Algorithmically Computed</div>
          <div style="display:flex; align-items:center; gap:30px; margin-bottom:40px; flex-wrap:wrap;">
            <div style="font-size:5rem; font-weight:900; color:var(--accent-green); line-height:1;">${cb.final_score ?? 'â€”'}</div>
            <div>
              <div style="font-size:0.8rem; opacity:0.5; margin-bottom:4px;">FINAL SCORE</div>
              <div style="font-size:0.75rem; opacity:0.35; font-family:monospace;">${cb.formula || '0.30Ã—IC + 0.30Ã—DC + 0.20Ã—RC + 0.20Ã—LC âˆ’ Penalty'}</div>
              ${cb.server_computed ? `<div style="font-size:10px; color:var(--accent-green); margin-top:6px;">âœ“ Server-computed Â· Not AI-generated</div>` : ''}
              ${cb.assumption_penalty ? `<div style="font-size:11px; color:var(--accent-pink); margin-top:4px;">Assumption penalty: ${cb.assumption_penalty} pts</div>` : ''}
            </div>
          </div>
          <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:20px;">
            ${[
          { key: 'input_clarity', label: 'Input Clarity', w: '30%', color: 'var(--accent-yellow)', formula: 'Score = Base(60) + Refinement' },
          { key: 'domain_consistency', label: 'Domain Consistency', w: '30%', color: 'var(--accent-blue)', formula: 'Score = (Traceable Features / Total) Ã— 100' },
          { key: 'requirement_completeness', label: 'Req. Completeness', w: '20%', color: 'var(--accent-pink)', formula: 'Score = (Covered NFRs / 5) Ã— 100' },
          { key: 'logical_coherence', label: 'Logical Coherence', w: '20%', color: 'var(--accent-green)', formula: 'Score = Base(100) - Inconsistency Penalties' }
        ].map(comp => {
          const data = cb[comp.key] || {};
          const score = data.score ?? 0;
          return `
              <div style="padding:20px; background:#080808; border-top:2px solid ${comp.color};" data-tooltip="${comp.formula}">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                  <span style="font-size:11px; color:${comp.color};">${comp.label} (w=${comp.w})</span>
                  <strong style="color:${comp.color};">${score}</strong>
                </div>
                <div style="height:6px; background:#111; border-radius:3px; margin-bottom:10px;">
                  <div style="height:100%; width:${score}%; background:${comp.color}; border-radius:3px; transition:width 0.8s ease;"></div>
                </div>
                <p style="font-size:11px; opacity:0.4;">${safeVal(data.justification, '')}</p>
              </div>`;
        }).join('')}
          </div>
        </div>

        <!-- â”€â”€ Â§9: Generated Prompts + Quick Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div style="grid-column:1/-1; margin-bottom:20px; border-bottom:var(--border-thin); padding-bottom:20px;">
          <h2 style="font-family: Outfit; font-size: 3rem; text-transform: uppercase; color: var(--accent-yellow);">Â§9 Â· Generated Prompts</h2>
        </div>
        ${[
          { id: 'chatgpt', title: 'ChatGPT (Reasoning)', content: prompts.chatgpt_specialized, key: 'chatgpt_specialized', toolKey: 'chatgpt', accentColor: 'var(--accent-green)' },
          { id: 'copilot', title: 'Copilot (Coding)', content: prompts.copilot_coding, key: 'copilot_coding', toolKey: 'copilot', accentColor: 'var(--accent-blue)' }
        ].map((p, i) => `
        <div class="platform-poster reveal" style="transition-delay:${i * 0.1}s">
          <h2 class="platform-title" style="font-size:1.5rem; color:${p.accentColor};">${p.title}</h2>
          <p style="font-size:0.95rem; opacity:0.8; margin-bottom:20px; min-height:80px;">${p.content ? (p.content.slice(0, 240) + '...') : 'Not generated'}</p>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <button class="platform-copy" onclick="copyPlatformText('${p.id}')" aria-label="Copy ${p.title} prompt" style="text-align:center; background:var(--bg); color:var(--fg); border:2px solid var(--fg);">COPY âžœ</button>
            <button onclick="openPreviewModal('${p.toolKey}', '${p.id}')" aria-label="Execute ${p.title} prompt via AI" style="text-align:center; background:${p.accentColor}; color:#000; border:none; font-weight:700; padding:10px; cursor:pointer; font-family:inherit; letter-spacing:1px; transition:opacity 0.2s;" onmouseenter="this.style.opacity=0.85" onmouseleave="this.style.opacity=1">â–¶ EXECUTE</button>
          </div>
        </div>`).join('')}

        <!-- â”€â”€ Quick Action Toolbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div style="grid-column:1/-1; margin-top:20px; padding:25px; border:1px solid #1a1a1a; background:#030303;">
          <div style="font-size:11px; color:#555; letter-spacing:3px; margin-bottom:18px;">âš¡ QUICK EXECUTE â€” SERVER-BACKED Â· Rate Limited Â· Sanitized</div>
          <div class="qa-toolbar-container" style="display:flex; gap:12px; flex-wrap:wrap; align-items:center;">
             <button class="qa-overflow-toggle" onclick="this.nextElementSibling.classList.toggle('open')">â‹¯ MORE ACTIONS</button>
             <div class="qa-btns-wrapper" style="display:flex; gap:12px; flex-wrap:wrap;">
               ${[{ k: 'chatgpt', label: 'ChatGPT', icon: 'ðŸ’¬', color: 'var(--accent-green)', promptKey: 'chatgpt_specialized' }, { k: 'copilot', label: 'Copilot', icon: 'ðŸ”§', color: 'var(--accent-blue)', promptKey: 'copilot_coding' }, { k: 'plan', label: 'Impl Plan', icon: 'ðŸ“‹', color: 'var(--accent-yellow)', promptKey: 'universal_master' }, { k: 'test-scaffold', label: 'Test Scaffold', icon: 'ðŸ§ª', color: 'var(--accent-pink)', promptKey: 'universal_master' }].map(t => `<button id="qa-btn-${t.k}" onclick="executeQuickAction('${t.k}', '${t.promptKey}')" aria-label="Execute ${t.label}" title="${t.label} (server-side execution)" style="padding:12px 20px; background:transparent; border:2px solid ${t.color}; color:${t.color}; font-family:inherit; font-size:13px; font-weight:700; letter-spacing:1px; cursor:pointer; transition:all 0.2s; border-radius:2px;" onmouseenter="this.style.background='${t.color}';this.style.color='#000'" onmouseleave="this.style.background='transparent';this.style.color='${t.color}'">${t.icon} ${t.label}</button>`).join('')}
             </div>
          </div>
          <div style="font-size:10px; color:#333; margin-top:12px;">Ctrl+Enter executes ChatGPT quickly. Prompts sanitized server-side. API keys never exposed to browser.</div>
        </div>

        <!-- â”€â”€ Â§10: Simulation Mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div style="grid-column:1/-1; padding:30px; border:1px solid #1a1a1a; background:#050505; margin-bottom:40px;">
          <div style="font-size:11px; color:var(--accent-blue); letter-spacing:3px; margin-bottom:20px;">Â§9 Â· SIMULATION MODE â€” Confidence Sensitivity Analysis</div>
          <button id="run-sim-btn" onclick="runSimulation()" style="background:transparent; border:1px solid var(--accent-blue); color:var(--accent-blue); padding:10px 20px; font-family:inherit; font-weight:700; cursor:pointer; transition:all 0.2s;" onmouseenter="this.style.background='var(--accent-blue)';this.style.color='#000'">â–¶ RUN SIMULATION</button>
          <div id="simulation-report-container">
             <p style="opacity:0.3; font-size:11px; margin-top:15px;">Run simulation to analyze how different drift thresholds [0.70, 0.55, 0.45] impact final confidence scores.</p>
          </div>
        </div>
      `;

      setTimeout(() => {
        document.querySelectorAll('#platform-grid .reveal').forEach(el => observer.observe(el));
      }, 100);
    }


    function copyPlatformText(id) {
      const prompts = state.results.generated_prompts || {};
      const map = { chatgpt: 'chatgpt_specialized', midjourney: 'midjourney_visual', copilot: 'copilot_coding' };
      const text = prompts[map[id]];
      if (!text) return;

      navigator.clipboard.writeText(text);
      const btn = event.target;
      const original = btn.textContent;
      btn.textContent = 'SYNC_COPIED';
      btn.style.background = 'var(--accent-green)';
      btn.style.color = '#000';
      setTimeout(() => {
        btn.textContent = original;
        btn.style.background = '';
        btn.style.color = '';
      }, 1500);
    }

    function copyText(key) {
      const display = document.getElementById('master-prompt-display');
      navigator.clipboard.writeText(display.textContent);
      const btn = event.target;
      const original = btn.textContent;
      btn.textContent = 'MASTER_COPIED';
      btn.style.background = 'var(--accent-green)';
      btn.style.color = '#000';
      setTimeout(() => {
        btn.textContent = original;
        btn.style.background = '';
        btn.style.color = '';
      }, 1500);
    }

    function showLoader(txt) {
      loaderSub.textContent = txt;
      loader.style.display = 'flex';
    }

    function hideLoader() {
      loader.style.display = 'none';
    }

    // --- ACCESSIBILITY HANDLERS ---
    function toggleHC() {
      document.body.classList.toggle('hc');
      localStorage.setItem('hc', document.body.classList.contains('hc') ? '1' : '0');
    }

    function changeFontSize(delta) {
      const el = document.documentElement;
      const current = parseFloat(getComputedStyle(el).fontSize);
      const next = Math.min(24, Math.max(14, current + delta));
      el.style.fontSize = next + 'px';
      localStorage.setItem('fontSize', next);
    }

    // Restore A11y
    if (localStorage.getItem('hc') === '1') document.body.classList.add('hc');
    if (localStorage.getItem('fontSize')) document.documentElement.style.fontSize = localStorage.getItem('fontSize') + 'px';

    // --- SIMULATION & EXPORT ---
    async function runSimulation() {
      if (!state.results) return;
      const btn = document.getElementById('run-sim-btn');
      btn.disabled = true;
      btn.textContent = 'SIMULATING...';

      try {
        const res = await fetch('/api/simulate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ data: state.results })
        });
        const report = await res.json();
        renderSimulationReport(report);
      } catch (err) {
        showError('Simulation failed: ' + err.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'RE-RUN SIMULATION';
      }
    }

    function renderSimulationReport(report) {
      const container = document.getElementById('simulation-report-container');
      container.innerHTML = `
        <table style="width:100%; border-collapse:collapse; margin-top:20px; font-size:12px;">
          <thead>
            <tr style="border-bottom:2px solid var(--accent-blue); text-align:left;">
              <th style="padding:10px;">THRESHOLD</th>
              <th style="padding:10px;">CONSISTENCY</th>
              <th style="padding:10px;">DELTA</th>
              <th style="padding:10px;">FINAL SCORE</th>
            </tr>
          </thead>
          <tbody>
            ${report.map(r => `
              <tr style="border-bottom:1px solid #222;">
                <td style="padding:10px;">${r.threshold.toFixed(2)}</td>
                <td style="padding:10px;">${r.domain_consistency.toFixed(1)}%</td>
                <td style="padding:10px; color:${r.confidence_delta >= 0 ? 'var(--accent-green)' : 'var(--accent-pink)'}">${r.confidence_delta >= 0 ? '+' : ''}${r.confidence_delta.toFixed(1)}</td>
                <td style="padding:10px; font-weight:900; color:var(--accent-yellow);">${r.final_score.toFixed(1)}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function exportMarkdown() {
      if (!state.results) return;
      const r = state.results;
      const md = `# RE-PROMPT Engineering Spec\n\n` +
        `## Domain\n${r.refined_domain_specification || r.refined_problem_statement}\n\n` +
        `## Confidence: ${r.confidence_breakdown.final_score}%\n\n` +
        `## Components\n` +
        (r.core_functional_components || []).map(f => `- **${f.name}**: ${f.description} (${f.trace_status})`).join('\n') +
        `\n\n## Master Prompt\n\`\`\`\n${r.generated_prompts.universal_master}\n\`\`\``;

      const blob = new Blob([md], { type: 'text/markdown' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `spec-${Date.now()}.md`;
      a.click();
    }

    // --- QUICK ACTION MODAL LOGIC ---
    let _activeToolKey = null;

    function openPreviewModal(toolKey, promptId) {
      _activeToolKey = toolKey;
      const prompts = state.results && state.results.generated_prompts ? state.results.generated_prompts : {};
      const keyMap = { chatgpt: 'chatgpt_specialized', copilot: 'copilot_coding', universal_master: 'universal_master' };
      const promptText = prompts[keyMap[promptId] || promptId] || prompts.universal_master || '';
      document.getElementById('modal-prompt-edit').value = promptText;
      document.getElementById('modal-tool-label').textContent = toolKey.toUpperCase();
      document.getElementById('modal-response').textContent = '';
      document.getElementById('modal-response-section').style.display = 'none';
      const btn = document.getElementById('modal-send-btn');
      btn.textContent = 'SEND TO ' + toolKey.toUpperCase();
      btn.disabled = false;
      document.getElementById('qa-modal').style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('qa-modal').style.display = 'none';
    }

    async function sendModalPrompt() {
      const prompt = document.getElementById('modal-prompt-edit').value.trim();
      const btn = document.getElementById('modal-send-btn');
      if (!prompt || !_activeToolKey) return;
      btn.textContent = '...PROCESSING';
      btn.disabled = true;
      document.getElementById('modal-response-section').style.display = 'none';
      try {
        const resp = await fetch('/api/execute-tool', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tool: _activeToolKey, prompt, prompt_meta: { source: 'preview-modal' } })
        });
        const data = await resp.json();
        if (!resp.ok || !data.ok) throw new Error(data.error || 'Server error');
        document.getElementById('modal-response').textContent = data.toolResponse;
        document.getElementById('modal-response-section').style.display = 'block';
        btn.textContent = 'DONE â€” Send Again';
        btn.disabled = false;
      } catch (err) {
        document.getElementById('modal-response').textContent = 'Error: ' + err.message;
        document.getElementById('modal-response-section').style.display = 'block';
        btn.textContent = 'RETRY';
        btn.disabled = false;
      }
    }

    async function executeQuickAction(toolKey, promptKey) {
      if (!state.results) { alert('Run analysis first.'); return; }
      openPreviewModal(toolKey, promptKey);
    }

    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape') closeModal();
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        if (document.getElementById('qa-modal').style.display === 'flex') {
          sendModalPrompt();
        } else if (state.results) {
          executeQuickAction('chatgpt', 'chatgpt_specialized');
        }
      }
    });
  </script>

  <div id="qa-modal" role="dialog" aria-modal="true" aria-label="Preview Execute"
    style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.92); z-index:9999; justify-content:center; align-items:flex-start; overflow-y:auto; padding:40px 20px;">
    <div
      style="background:#0a0a0a; border:2px solid #333; max-width:860px; width:100%; padding:40px; position:relative;">
      <button onclick="closeModal()" aria-label="Close"
        style="position:absolute; top:16px; right:16px; background:none; border:1px solid #444; color:#fff; font-size:18px; cursor:pointer; padding:4px 10px; font-family:inherit;">X</button>
      <div style="font-size:11px; color:var(--accent-blue); letter-spacing:3px; margin-bottom:8px;">PREVIEW EXECUTE
      </div>
      <h3 id="modal-tool-label"
        style="font-family:Outfit; font-size:1.8rem; color:var(--accent-yellow); margin-bottom:24px; text-transform:uppercase;">
      </h3>
      <div style="font-size:11px; opacity:0.4; margin-bottom:8px;">Edit before sending. Ctrl+Enter to execute.
        Server-sanitized and rate-limited.</div>
      <textarea id="modal-prompt-edit" aria-label="Prompt editor"
        style="width:100%; min-height:220px; background:#050505; border:1px solid #333; color:#f4f4f4; font-family:monospace; font-size:13px; padding:16px; resize:vertical; line-height:1.6;"></textarea>
      <div style="display:flex; gap:12px; margin-top:16px; flex-wrap:wrap;">
        <button id="modal-send-btn" onclick="sendModalPrompt()" aria-label="Execute prompt"
          style="flex:1; padding:14px; background:var(--accent-green); color:#000; font-family:inherit; font-weight:700; font-size:14px; border:none; cursor:pointer; letter-spacing:1px;">SEND</button>
        <button onclick="closeModal()" aria-label="Cancel"
          style="padding:14px 24px; background:transparent; border:2px solid #444; color:#fff; font-family:inherit; cursor:pointer; font-size:13px;">CANCEL</button>
      </div>
      <div id="modal-response-section"
        style="display:none; margin-top:24px; border-top:1px solid #222; padding-top:20px;">
        <div style="font-size:11px; color:var(--accent-green); letter-spacing:2px; margin-bottom:10px;">AI RESPONSE
        </div>
        <pre id="modal-response"
          style="white-space:pre-wrap; font-family:monospace; font-size:13px; line-height:1.7; max-height:400px; overflow-y:auto; background:#050505; padding:20px; border:1px solid #1a1a1a;"></pre>
        <button onclick="navigator.clipboard.writeText(document.getElementById('modal-response').textContent)"
          aria-label="Copy AI response"
          style="margin-top:10px; padding:10px 18px; background:transparent; border:2px solid var(--accent-green); color:var(--accent-green); font-family:inherit; cursor:pointer; font-size:12px;">COPY
          RESPONSE</button>
      </div>
    </div>
  </div>

</body>

</html>